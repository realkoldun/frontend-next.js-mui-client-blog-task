name: Deploy Next.js site to Verсel

on:
    push:
      branches:
        - '*'
    pull_request:
        branches: ['dev', 'main']

    workflow_dispatch:

concurrency:
    group: 'pages'
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Detect package manager
              id: detect-package-manager
              run: |
                if [ -f "${{ github.workspace }}/yarn.lock" ]; then
                  echo "manager=yarn" >> $GITHUB_OUTPUT
                  echo "command=install --frozen-lockfile" >> $GITHUB_OUTPUT
                  echo "runner=yarn" >> $GITHUB_OUTPUT
                  exit 0
                elif [ -f "${{ github.workspace }}/package.json" ]; then
                  echo "manager=npm" >> $GITHUB_OUTPUT
                  echo "command=ci" >> $GITHUB_OUTPUT
                  echo "runner=npx --no-install" >> $GITHUB_OUTPUT
                  exit 0
                else
                  echo "Unable to determine package manager"
                  exit 1
                fi

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: ${{ steps.detect-package-manager.outputs.manager }}

            - name: Install dependencies
              run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}

            - name: Eslint
              run: ${{ steps.detect-package-manager.outputs.runner }} eslint

            - name: Prettier
              run: ${{ steps.detect-package-manager.outputs.runner }} prettier

            - name: Playwright Browsers
              run: npx playwright install --with-deps

            - name: Playwright
              run: ${{ steps.detect-package-manager.outputs.runner }} e2e

    deploy:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Detect package manager
              id: detect-package-manager
              run: |
                if [ -f "${{ github.workspace }}/yarn.lock" ]; then
                  echo "manager=yarn" >> $GITHUB_OUTPUT
                  echo "command=install --frozen-lockfile" >> $GITHUB_OUTPUT
                  echo "runner=yarn" >> $GITHUB_OUTPUT
                  exit 0
                elif [ -f "${{ github.workspace }}/package.json" ]; then
                  echo "manager=npm" >> $GITHUB_OUTPUT
                  echo "command=ci" >> $GITHUB_OUTPUT
                  echo "runner=npx --no-install" >> $GITHUB_OUTPUT
                  exit 0
                else
                  echo "Unable to determine package manager"
                  exit 1
                fi

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                node-version: '20'
                cache: ${{ steps.detect-package-manager.outputs.manager }}

            - name: Install dependencies
              run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}

            - name: Build with Next.js
              run: ${{ steps.detect-package-manager.outputs.runner }} build

            - name: Vercel deploy
              run: |
                npm i -g vercel
                vercel --prod --yes --token ${{ secrets.VERCEL_TOKEN }}
